// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOUVELLE LOGIQUE COMPL√àTE - VUE D'ENSEMBLE PERMANENTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Initialiser la liste des classes disponibles
function initAvailableClassesList() {
  availableClassesList.innerHTML = availableClasses.map(cls => `
    <div class="flex items-center justify-between p-2 bg-white rounded border border-slate-200">
      <span class="font-medium text-slate-700">${cls.name}</span>
      <span class="text-slate-500">${cls.students} √©l.</span>
    </div>
  `).join('');
}

// Mettre √† jour le header contextuel
function updateHeaderContext() {
  const scenarioNames = { 'needs': 'Besoins', 'lv2': 'LV2' };
  const modeNames = { 'heterogeneous': 'H√©t√©rog√®ne', 'homogeneous': 'Homog√®ne' };
  
  contextScenario.textContent = state.scenario ? scenarioNames[state.scenario] : 'Non s√©lectionn√©';
  contextMode.textContent = state.distributionMode ? modeNames[state.distributionMode] : 'Non s√©lectionn√©';
  contextCount.textContent = state.regroupements.length;
}

// VOLET 1 : S√©lection du sc√©nario
function selectScenario(scenario, button) {
  state.scenario = scenario;
  console.log(`‚úÖ Sc√©nario: ${scenario}`);
  
  [btnNeeds, btnLv2].forEach(btn => {
    btn.classList.remove('ring-2', 'ring-purple-500', 'bg-purple-50');
  });
  button.classList.add('ring-2', 'ring-purple-500', 'bg-purple-50');
  
  updateHeaderContext();
}

btnNeeds.addEventListener('click', () => selectScenario('needs', btnNeeds));
btnLv2.addEventListener('click', () => selectScenario('lv2', btnLv2));

// VOLET 1 : S√©lection du mode de distribution
function selectDistribution(mode, button) {
  state.distributionMode = mode;
  console.log(`‚úÖ Mode: ${mode}`);
  
  [btnHeterogeneous, btnHomogeneous].forEach(btn => {
    btn.classList.remove('ring-2', 'ring-purple-500');
  });
  button.classList.add('ring-2', 'ring-purple-500');
  
  updateHeaderContext();
}

btnHeterogeneous.addEventListener('click', () => selectDistribution('heterogeneous', btnHeterogeneous));
btnHomogeneous.addEventListener('click', () => selectDistribution('homogeneous', btnHomogeneous));

// VOLET 2 : Cr√©er un nouveau regroupement
function createNewRegroupement() {
  regroupementCounter++;
  const regroupementId = `regroupement-${regroupementCounter}`;
  
  const regroupement = {
    id: regroupementId,
    name: `Regroupement ${regroupementCounter}`,
    classes: [],
    groupsCount: 3,
    status: 'draft' // draft, validated
  };
  
  state.regroupements.push(regroupement);
  
  renderRegroupementsList();
  selectRegroupement(regroupementId);
  updateHeaderContext();
  
  console.log(`‚úÖ Regroupement ${regroupementCounter} cr√©√©`);
}

// Afficher la liste des regroupements
function renderRegroupementsList() {
  if (state.regroupements.length === 0) {
    regroupementsList.innerHTML = `
      <div class="text-center text-slate-400 py-8">
        <i class="fas fa-layer-group text-3xl mb-2"></i>
        <p class="text-xs">Aucun regroupement</p>
        <p class="text-xs mt-1">Cliquez sur "Nouveau"</p>
      </div>
    `;
    return;
  }
  
  regroupementsList.innerHTML = state.regroupements.map(r => {
    const isActive = r.id === currentRegroupementId;
    const totalStudents = r.classes.reduce((sum, classId) => {
      const cls = availableClasses.find(c => c.id === classId);
      return sum + (cls ? cls.students : 0);
    }, 0);
    
    return `
      <div class="regroupement-item p-3 rounded-lg border-2 ${isActive ? 'border-purple-500 bg-purple-50' : 'border-slate-200 bg-white'} cursor-pointer hover:border-purple-300 transition-all" data-id="${r.id}">
        <div class="flex items-center justify-between mb-2">
          <span class="font-bold text-sm text-slate-900">${r.name}</span>
          ${r.status === 'draft' ? '<span class="text-xs px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded">Brouillon</span>' : '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded">Valid√©</span>'}
        </div>
        <div class="flex items-center gap-3 text-xs text-slate-600">
          <span><i class="fas fa-school mr-1"></i>${r.classes.length}</span>
          <span><i class="fas fa-users mr-1"></i>${totalStudents}</span>
          <span><i class="fas fa-layer-group mr-1"></i>${r.groupsCount}</span>
        </div>
      </div>
    `;
  }).join('');
  
  // Event listeners
  container.querySelectorAll('.regroupement-item').forEach(item => {
    item.addEventListener('click', () => {
      selectRegroupement(item.dataset.id);
    });
  });
  
  // Activer le bouton "G√©n√©rer tout" si au moins un regroupement valide
  const hasValidRegroupement = state.regroupements.some(r => r.classes.length >= 2);
  btnGenerateAll.disabled = !hasValidRegroupement;
}

// S√©lectionner un regroupement pour l'√©diter
function selectRegroupement(regroupementId) {
  currentRegroupementId = regroupementId;
  const regroupement = state.regroupements.find(r => r.id === regroupementId);
  
  if (!regroupement) return;
  
  // Afficher le panneau de d√©tail
  detailEmpty.classList.add('hidden');
  detailHeader.classList.remove('hidden');
  detailForm.classList.remove('hidden');
  
  // Mettre √† jour le titre
  detailTitle.textContent = regroupement.name;
  
  // G√©n√©rer les checkboxes de classes
  detailClassesSelector.innerHTML = availableClasses.map(cls => `
    <label class="flex items-center gap-2 p-3 bg-white rounded-lg border-2 ${regroupement.classes.includes(cls.id) ? 'border-purple-500 bg-purple-50 ring-2 ring-purple-200' : 'border-slate-200'} hover:border-purple-400 cursor-pointer transition-all">
      <input type="checkbox" class="class-checkbox w-4 h-4 text-purple-600 rounded" value="${cls.id}" data-students="${cls.students}" ${regroupement.classes.includes(cls.id) ? 'checked' : ''}>
      <span class="text-sm font-medium text-slate-700">${cls.name}</span>
      <span class="ml-auto text-xs text-slate-500">${cls.students} √©l.</span>
    </label>
  `).join('');
  
  // Mettre √† jour le nombre de groupes
  detailGroupsInput.value = regroupement.groupsCount;
  
  // Event listeners pour les checkboxes
  const checkboxes = detailClassesSelector.querySelectorAll('.class-checkbox');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => updateCurrentRegroupement());
  });
  
  // Event listener pour le nombre de groupes
  detailGroupsInput.addEventListener('input', () => updateCurrentRegroupement());
  
  // Mettre √† jour les stats
  updateRegroupementStats();
  
  // Mettre √† jour la liste pour montrer la s√©lection
  renderRegroupementsList();
  
  console.log(`üìã Regroupement s√©lectionn√©: ${regroupementId}`);
}

// Mettre √† jour le regroupement actuel
function updateCurrentRegroupement() {
  const regroupement = state.regroupements.find(r => r.id === currentRegroupementId);
  if (!regroupement) return;
  
  const checkboxes = detailClassesSelector.querySelectorAll('.class-checkbox');
  const selectedClasses = Array.from(checkboxes).filter(cb => cb.checked);
  
  regroupement.classes = selectedClasses.map(cb => cb.value);
  regroupement.groupsCount = parseInt(detailGroupsInput.value);
  
  // Mettre √† jour le feedback visuel
  checkboxes.forEach(cb => {
    const label = cb.closest('label');
    if (cb.checked) {
      label.classList.add('bg-purple-50', 'border-purple-500', 'ring-2', 'ring-purple-200');
      label.classList.remove('border-slate-200');
    } else {
      label.classList.remove('bg-purple-50', 'border-purple-500', 'ring-2', 'ring-purple-200');
      label.classList.add('border-slate-200');
    }
  });
  
  updateRegroupementStats();
  renderRegroupementsList();
}

// Mettre √† jour les statistiques du regroupement actuel
function updateRegroupementStats() {
  const regroupement = state.regroupements.find(r => r.id === currentRegroupementId);
  if (!regroupement) return;
  
  const totalStudents = regroupement.classes.reduce((sum, classId) => {
    const cls = availableClasses.find(c => c.id === classId);
    return sum + (cls ? cls.students : 0);
  }, 0);
  
  detailClassesCount.textContent = regroupement.classes.length;
  detailStudentsCount.textContent = totalStudents;
  detailGroupsCount.textContent = regroupement.groupsCount;
  
  // Activer/d√©sactiver le bouton g√©n√©rer
  btnGenerateCurrent.disabled = regroupement.classes.length < 2;
  
  console.log(`üìä Stats: ${regroupement.classes.length} classes, ${totalStudents} √©l√®ves, ${regroupement.groupsCount} groupes`);
}

// Supprimer le regroupement actuel
btnDeleteCurrent.addEventListener('click', () => {
  if (!currentRegroupementId) return;
  
  const index = state.regroupements.findIndex(r => r.id === currentRegroupementId);
  if (index > -1) {
    state.regroupements.splice(index, 1);
    currentRegroupementId = null;
    
    // Masquer le panneau de d√©tail
    detailEmpty.classList.remove('hidden');
    detailHeader.classList.add('hidden');
    detailForm.classList.add('hidden');
    
    renderRegroupementsList();
    updateHeaderContext();
    
    console.log(`üóëÔ∏è Regroupement supprim√©`);
  }
});

// Sauvegarder en brouillon
btnSaveDraft.addEventListener('click', () => {
  const regroupement = state.regroupements.find(r => r.id === currentRegroupementId);
  if (regroupement) {
    regroupement.status = 'draft';
    renderRegroupementsList();
    console.log(`üíæ Regroupement sauvegard√© en brouillon`);
  }
});

// G√©n√©rer le regroupement actuel
btnGenerateCurrent.addEventListener('click', () => {
  const regroupement = state.regroupements.find(r => r.id === currentRegroupementId);
  if (!regroupement) return;
  
  console.log(`üéØ G√©n√©ration du regroupement:`, regroupement);
  alert(`G√©n√©ration en cours...\n\nClasses: ${regroupement.classes.join(', ')}\nGroupes: ${regroupement.groupsCount}`);
  
  regroupement.status = 'validated';
  renderRegroupementsList();
});

// G√©n√©rer tous les regroupements
btnGenerateAll.addEventListener('click', () => {
  console.log(`üéØ G√©n√©ration de tous les regroupements:`, state);
  
  const summary = state.regroupements.map((r, i) => 
    `${r.name}: ${r.classes.join(', ')} ‚Üí ${r.groupsCount} groupes`
  ).join('\n');
  
  alert(`G√©n√©ration de tous les regroupements...\n\nSc√©nario: ${state.scenario}\nMode: ${state.distributionMode}\n\n${summary}`);
});

// Event listener pour cr√©er un nouveau regroupement
btnNewRegroupement.addEventListener('click', createNewRegroupement);

// Initialisation
initAvailableClassesList();
updateHeaderContext();

console.log('‚úÖ Interface V4 - Vue d'ensemble permanente initialis√©e');
