<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Int√©gration Module V4 - Bundles</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .status.ok { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .status.error { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .status.pending { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .instruction {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
            font-weight: bold;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .error-text { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Int√©gration Module Groupes V4 - Bundles Web App</h1>

    <div class="instruction">
        <strong>üìå OBJECTIF</strong> : Charger les bundles V4 via un endpoint Web App
        (√©vite les erreurs 404 ‚Üí SyntaxError)
    </div>

    <!-- √âTAPE 1: Configuration -->
    <h2>üìã √âTAPE 1 : Configuration du Web App Endpoint</h2>

    <div class="status pending">
        ‚è≥ <strong>Statut</strong> : Endpoint non configur√©
    </div>

    <div class="instruction">
        <h3>√Ä faire dans Apps Script:</h3>
        <ol>
            <li>Ouvrir le projet Apps Script</li>
            <li>Copier le contenu de <code>serve_v4_bundles.gs</code></li>
            <li>Coller dans un nouveau fichier <code>.gs</code></li>
            <li>Ex√©cuter <code>uploadV4Bundles()</code> (d√©p√¥t des fichiers JS)</li>
            <li>Ex√©cuter <code>getWebAppUrl()</code> (obtenir l'URL)</li>
            <li>D√©ployer en tant que Web App:
                <ul>
                    <li>Ex√©cuter en tant que: <strong>Votre compte</strong></li>
                    <li>Acc√®s: <strong>Tous (m√™me les utilisateurs anonymes)</strong></li>
                </ul>
            </li>
        </ol>
    </div>

    <h3>Votre URL Web App:</h3>
    <div class="code-block" id="webAppUrl">
        ‚ùå √Ä obtenir depuis Apps Script (ex√©cuter getWebAppUrl())
    </div>

    <p>
        <input type="text" id="urlInput" placeholder="Copier l'URL du Web App ici" style="width: 100%; padding: 10px; font-family: monospace;">
    </p>

    <!-- √âTAPE 2: Tests de chargement -->
    <h2>üß™ √âTAPE 2 : Tests de Chargement</h2>

    <p>
        <button class="secondary" onclick="testEndpoint()">Test 1: V√©rifier l'endpoint</button>
        <button class="secondary" onclick="testBundles()">Test 2: Charger les bundles</button>
        <button class="secondary" onclick="testInstantiation()">Test 3: Instancier V4</button>
    </p>

    <div class="log" id="testLog">
        <div class="log-entry">üîç Logs du test (les r√©sultats appara√Ætront ici)</div>
    </div>

    <!-- √âTAPE 3: Statuts des bundles -->
    <h2>üì¶ √âTAPE 3 : Statut des Bundles</h2>

    <table>
        <tr>
            <th>Fichier</th>
            <th>Taille</th>
            <th>Statut</th>
            <th>Action</th>
        </tr>
        <tr>
            <td>InterfaceV4_Triptyque_Logic.js</td>
            <td id="size-triptyque">?</td>
            <td id="status-triptyque" class="warning">‚è≥ Non test√©</td>
            <td><button class="secondary" onclick="loadBundle('InterfaceV4_Triptyque_Logic.js')">Charger</button></td>
        </tr>
        <tr>
            <td>GroupsAlgorithmV4_Distribution.js</td>
            <td id="size-algo">?</td>
            <td id="status-algo" class="warning">‚è≥ Non test√©</td>
            <td><button class="secondary" onclick="loadBundle('GroupsAlgorithmV4_Distribution.js')">Charger</button></td>
        </tr>
        <tr>
            <td>InterfaceV2_GroupsModuleV4_Script.js</td>
            <td id="size-loader">?</td>
            <td id="status-loader" class="warning">‚è≥ Non test√©</td>
            <td><button class="secondary" onclick="loadBundle('InterfaceV2_GroupsModuleV4_Script.js')">Charger</button></td>
        </tr>
    </table>

    <!-- √âTAPE 4: Int√©gration -->
    <h2>üíæ √âTAPE 4 : Int√©gration dans le HTML</h2>

    <p>Ajouter dans votre HTML principal (apr√®s que les donn√©es soient inject√©es):</p>

    <div class="code-block">
// Charger les bundles V4 via l'endpoint Web App
const V4_WEB_APP_URL = "https://script.google.com/macros/d/YOUR_DEPLOYMENT_ID/usercache";

// 1. Charger Triptyque Logic
fetch(V4_WEB_APP_URL + "?file=InterfaceV4_Triptyque_Logic.js")
  .then(r => r.text())
  .then(code => {
    eval(code);  // ou: new Function(code)()
    console.log("‚úÖ Triptyque_Logic charg√©");
  })
  .catch(err => console.error("‚ùå Erreur Triptyque:", err));

// 2. Charger Algorithme
fetch(V4_WEB_APP_URL + "?file=GroupsAlgorithmV4_Distribution.js")
  .then(r => r.text())
  .then(code => {
    eval(code);
    console.log("‚úÖ Algorithm V4 charg√©");
  })
  .catch(err => console.error("‚ùå Erreur Algo:", err));

// 3. Charger Loader
fetch(V4_WEB_APP_URL + "?file=InterfaceV2_GroupsModuleV4_Script.js")
  .then(r => r.text())
  .then(code => {
    eval(code);
    console.log("‚úÖ Loader V4 charg√©");
    // Maintenant window.ModuleGroupsV4 est disponible ‚úÖ
  })
  .catch(err => console.error("‚ùå Erreur Loader:", err));
    </div>

    <!-- √âTAPE 5: Checklist finale -->
    <h2>‚úÖ Checklist Finale</h2>

    <div style="margin: 20px 0;">
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check1"> <strong>Endpoint Web App cr√©√© et d√©ploy√©</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check2"> <strong>Bundles charg√©s dans ScriptProperties (uploadV4Bundles())</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check3"> <strong>Test 1 r√©ussi: Endpoint accessible</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check4"> <strong>Test 2 r√©ussi: Bundles t√©l√©charg√©s sans 404</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check5"> <strong>Test 3 r√©ussi: ModuleGroupsV4 instanti√© sans erreur</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check6"> <strong>GROUPS_MODULE_V4_DATA inject√© (vraies donn√©es)</strong>
        </label>
        <label style="display: block; margin: 10px 0;">
            <input type="checkbox" id="check7"> <strong>Triptyque affiche vraies classes (pas DEFAULT_CLASSES)</strong>
        </label>
    </div>

    <button onclick="saveChecklist()" style="background: #4CAF50; width: 100%;">üíæ Sauvegarder la checklist</button>

</div>

<script>
// ============================================================================
// SCRIPTS DE TEST
// ============================================================================

function log(message) {
    const logDiv = document.getElementById('testLog');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.textContent = message;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
}

function testEndpoint() {
    const url = document.getElementById('urlInput').value;
    if (!url) {
        alert('‚ùå Entrez l\'URL du Web App endpoint');
        return;
    }

    log('üîç Test 1: V√©rification de l\'endpoint...');

    fetch(url + '?file=InterfaceV4_Triptyque_Logic.js')
        .then(response => {
            log(`üìä Status HTTP: ${response.status}`);
            if (response.status === 200) {
                log('‚úÖ Endpoint accessible');
                document.getElementById('status-triptyque').innerHTML = '<span class="success">‚úÖ Endpoint OK</span>';
            } else {
                log(`‚ö†Ô∏è Erreur HTTP ${response.status}`);
            }
            return response.headers.get('content-type');
        })
        .then(contentType => {
            log(`üìù Content-Type: ${contentType}`);
            if (contentType && contentType.includes('javascript')) {
                log('‚úÖ MIME type correct (application/javascript)');
            } else {
                log('‚ö†Ô∏è MIME type incorrect (attendu: application/javascript)');
            }
        })
        .catch(error => {
            log(`‚ùå Erreur: ${error.message}`);
            document.getElementById('status-triptyque').innerHTML = '<span class="error-text">‚ùå Erreur r√©seau</span>';
        });
}

function testBundles() {
    const url = document.getElementById('urlInput').value;
    if (!url) {
        alert('‚ùå Entrez l\'URL du Web App endpoint');
        return;
    }

    log('üß™ Test 2: Chargement des bundles...');

    const files = [
        'InterfaceV4_Triptyque_Logic.js',
        'GroupsAlgorithmV4_Distribution.js',
        'InterfaceV2_GroupsModuleV4_Script.js'
    ];

    files.forEach(file => {
        fetch(url + '?file=' + file)
            .then(r => r.text())
            .then(content => {
                const size = (content.length / 1024).toFixed(2);
                log(`‚úÖ ${file} charg√© (${size} KB)`);
                document.getElementById('size-' + (
                    file.includes('Triptyque') ? 'triptyque' :
                    file.includes('Algorithm') ? 'algo' : 'loader'
                )).textContent = size + ' KB';
                document.getElementById('status-' + (
                    file.includes('Triptyque') ? 'triptyque' :
                    file.includes('Algorithm') ? 'algo' : 'loader'
                )).innerHTML = '<span class="success">‚úÖ Charg√©</span>';
            })
            .catch(err => {
                log(`‚ùå ${file}: ${err.message}`);
                document.getElementById('status-' + (
                    file.includes('Triptyque') ? 'triptyque' :
                    file.includes('Algorithm') ? 'algo' : 'loader'
                )).innerHTML = '<span class="error-text">‚ùå Erreur</span>';
            });
    });
}

function testInstantiation() {
    log('üî® Test 3: Instanciation ModuleGroupsV4...');

    if (typeof window.ModuleGroupsV4 !== 'undefined') {
        try {
            const module = new window.ModuleGroupsV4();
            log('‚úÖ ModuleGroupsV4 instanci√© avec succ√®s');

            if (typeof window.GROUPS_MODULE_V4_DATA !== 'undefined') {
                log(`‚úÖ GROUPS_MODULE_V4_DATA disponible (${window.GROUPS_MODULE_V4_DATA.classes?.length || 0} classes)`);
            } else {
                log('‚ö†Ô∏è GROUPS_MODULE_V4_DATA manquant - donn√©es non inject√©es');
            }
        } catch (error) {
            log(`‚ùå Erreur instanciation: ${error.message}`);
        }
    } else {
        log('‚ùå window.ModuleGroupsV4 non trouv√© - charger les bundles d\'abord');
    }
}

function loadBundle(fileName) {
    const url = document.getElementById('urlInput').value;
    if (!url) {
        alert('‚ùå Entrez l\'URL du Web App endpoint');
        return;
    }

    log(`üì• Chargement ${fileName}...`);

    fetch(url + '?file=' + fileName)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.text();
        })
        .then(content => {
            eval(content);
            log(`‚úÖ ${fileName} √©valu√© et charg√©`);

            if (fileName.includes('Triptyque')) {
                if (typeof window.TriptychGroupsModule !== 'undefined') {
                    log('‚úÖ Classe TriptychGroupsModule disponible');
                }
            } else if (fileName.includes('Algorithm')) {
                if (typeof window.GroupsAlgorithmV4 !== 'undefined') {
                    log('‚úÖ Classe GroupsAlgorithmV4 disponible');
                }
            } else if (fileName.includes('Script')) {
                if (typeof window.ModuleGroupsV4 !== 'undefined') {
                    log('‚úÖ Classe ModuleGroupsV4 disponible');
                }
            }
        })
        .catch(err => log(`‚ùå Erreur: ${err.message}`));
}

function saveChecklist() {
    const checks = [
        document.getElementById('check1').checked,
        document.getElementById('check2').checked,
        document.getElementById('check3').checked,
        document.getElementById('check4').checked,
        document.getElementById('check5').checked,
        document.getElementById('check6').checked,
        document.getElementById('check7').checked
    ];

    localStorage.setItem('v4-checklist', JSON.stringify(checks));
    alert('‚úÖ Checklist sauvegard√©e');
}

// Charger la checklist au d√©marrage
window.addEventListener('load', () => {
    const saved = localStorage.getItem('v4-checklist');
    if (saved) {
        const checks = JSON.parse(saved);
        checks.forEach((checked, i) => {
            document.getElementById('check' + (i+1)).checked = checked;
        });
    }
});

</script>

</body>
</html>
